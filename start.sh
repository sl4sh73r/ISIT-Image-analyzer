#!/bin/bash

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ะะฐะณััะทะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั ะธะท .env ัะฐะนะปะฐ
if [ -f ".env" ]; then
    export $(grep -v '^#' .env | xargs)
    echo -e "${GREEN}โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะทะฐะณััะถะตะฝั ะธะท .env${NC}"
fi

echo -e "${BLUE}๐ ะะฐะฟััะบ Corporate API Image Analyzer (Batch + Dynamic Vision Models)${NC}"
echo ""
echo -e "${YELLOW}๐ ะขัะตะฑะพะฒะฐะฝะธั:${NC}"
echo "   1. ะฃััะฐะฝะพะฒะปะตะฝะฐ ะฟะตัะตะผะตะฝะฝะฐั API_KEY: export API_KEY='ะฒะฐั_ะบะปัั'"
echo "   2. ะะฝัะตัะฝะตั-ัะพะตะดะธะฝะตะฝะธะต ะดะปั ะดะพัััะฟะฐ ะบ ะบะพัะฟะพัะฐัะธะฒะฝะพะผั API"
echo "   3. ะะพัะฟะพัะฐัะธะฒะฝัะน API ะดะพะปะถะตะฝ ะฑััั ะดะพัััะฟะตะฝ"
echo ""

# ะัะพะฒะตัะบะฐ API_KEY
if [ -z "$API_KEY" ]; then
    echo -e "${YELLOW}โ๏ธ  API_KEY ะฝะต ัััะฐะฝะพะฒะปะตะฝ${NC}"
    echo "   ะฃััะฐะฝะพะฒะธัะต: export API_KEY='ะฒะฐั_ะบะปัั'"
    echo "   ะะปะธ ะฒัะฟะพะปะฝะธัะต: source set_api_key.sh"
    echo ""
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d ".venv" ]; then
    echo -e "${YELLOW}โ๏ธ  ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ${NC}"
    echo "   ะกะพะทะดะฐั ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต..."
    python3 -m venv .venv
    echo -e "${GREEN}โ ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ัะพะทะดะฐะฝะพ${NC}"
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo -e "${BLUE}๐ฆ ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั...${NC}"
source .venv/bin/activate

# ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo -e "${BLUE}๐ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน...${NC}"
if ! python -c "import flask, requests" 2>/dev/null; then
    echo -e "${YELLOW}โ๏ธ  ะะตะบะพัะพััะต ะทะฐะฒะธัะธะผะพััะธ ะฝะต ัััะฐะฝะพะฒะปะตะฝั${NC}"
    echo "   ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะทะฐะฒะธัะธะผะพััะธ..."
    pip install -r requirements.txt
    echo -e "${GREEN}โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั${NC}"
else
    echo -e "${GREEN}โ ะัะต ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั${NC}"
fi

# ะัะพะฒะตัะบะฐ LM Studio
echo ""
echo -e "${BLUE}๐ ะัะพะฒะตัะบะฐ ะบะพัะฟะพัะฐัะธะฒะฝะพะณะพ API...${NC}"
if curl -s -H "Authorization: Bearer $API_KEY" https://llama.sndi.my/api/v1/models > /dev/null 2>&1; then
    echo -e "${GREEN}โ ะะพัะฟะพัะฐัะธะฒะฝัะน API ะดะพัััะฟะตะฝ${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะะพัะฟะพัะฐัะธะฒะฝัะน API ะฝะต ะพัะฒะตัะฐะตั${NC}"
    echo -e "${YELLOW}   ะฃะฑะตะดะธัะตัั, ััะพ:${NC}"
    echo "   1. API_KEY ัััะฐะฝะพะฒะปะตะฝ: export API_KEY='ะฒะฐั_ะบะปัั'"
    echo "   2. ะะฝัะตัะฝะตั-ัะพะตะดะธะฝะตะฝะธะต ัะฐะฑะพัะฐะตั"
    echo "   3. ะะพัะฟะพัะฐัะธะฒะฝัะน API ะดะพัััะฟะตะฝ"
    echo ""
fi

echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะะพัะพะฒ ะบ ะทะฐะฟััะบั!${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั
echo -e "${BLUE}๐ ะะฐะฟััะบ Flask ะฟัะธะปะพะถะตะฝะธั...${NC}"
echo -e "${YELLOW}   ะัะบัะพะนัะต ะฑัะฐัะทะตั: http://127.0.0.1:5001${NC}"
echo ""
echo -e "${GREEN}๐ก ะะพะทะผะพะถะฝะพััะธ:${NC}"
echo "   โข ะะฐะณััะทะบะฐ ะดะพ 35 ะธะทะพะฑัะฐะถะตะฝะธะน ะพะดะฝะพะฒัะตะผะตะฝะฝะพ"
echo "   โข ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะฑะพั ะฒัะตั ะดะพัััะฟะฝัั VLM-ะผะพะดะตะปะตะน ั vision"
echo "   โข ะฃะฟัะฐะฒะปะตะฝะธะต ะผะพะดะตะปัะผะธ ะธะท ะฒะตะฑ-ะธะฝัะตััะตะนัะฐ"
echo "   โข ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพะต ััะฐะฒะฝะตะฝะธะต ะฒัะตั ะผะพะดะตะปะตะน"
echo "   โข ะะพัะฟะพัะฐัะธะฒะฝัะน API - ะฝะตั ะฝะตะพะฑัะพะดะธะผะพััะธ ะฒ ะปะพะบะฐะปัะฝะพะผ LM Studio"
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

python app.py
